angular.module("heatMap",["ui.router","ngMaterial"]).config(["$urlRouterProvider","$locationProvider","$mdThemingProvider",function(a,b,c){a.otherwise("/"),b.html5Mode(!0),c.theme("default").primaryPalette("blue").accentPalette("orange").warnPalette("red"),c.enableBrowserColor({theme:"default"})}]).run(["$window","$rootScope",function(a,b){function c(){e=!1,f=0}console.log("listening for Konami code");var d=[38,38,40,40,37,39,37,39,66,65],e=!1,f=0,g=angular.element(a);g.bind("keydown",function(a){var g=a.keyCode;e||38===g&&(e=!0),e?(d[f]===g?f++:c(),10===f&&(b.$emit("konami"),c())):c()})}]),angular.module("heatMap").controller("MainCtrl",["$scope","$http","$state","WebService","$q","$rootScope","$timeout",function(a,b,c,d,e,f,g){var h=this;c.go("main"),h.colorArr=["#01579B","#006064","#004D40","#1B5E20","#33691E","#827717","#F57F17","#FF6F00","#E65100","#B71C1C"],h.altColorArr=["#26C6DA","#26A69A","#66BB6A","#9CCC65","#D4E157","#FFEE58","#FFCA28","#FFA726","#FF7043","#EF5350"],a.severity=0,a.currentValue=0,h.options={thresh:680,increments:10,width:848,handleColor:"#311B92",trackColor:"#B0BEC5",sliderTitle:"Severity"},h.konami=!1,h.axisLabels={yAxis:["Sun","Mon","Tue","Wed","Thur","Fri","Sat"],xAxis:["1a","2a","3a","4a","5a","6a","7a","8a","9a","10a","11a","12p","1p","2p","3p","4p","5p","6p","7p","8p","9p","10p","11p","12a"]},d.getHeatmapData(!1,h.axisLabels,"value").then(function(a){a.error||(h.hmData=a)}),h.axisLabelsOther={yAxis:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],xAxis:["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24"]},d.getHeatmapData(!0,h.axisLabelsOther,"value").then(function(a){a.error||(h.hmDataOther=a)}),h.thirdColorArr=["#D50000","#C51162","#4A148C","#311B92","#1A237E","#0D47A1","#0091EA","#00B8D4","#00BFA5","#1B5E20","#33691E","#827717"],h.crazyAxis={yAxis:["Mario","Luigi","Peach","Toad","Yoshi","Bowser","Boo"],xAxis:Array.apply(null,{length:30}).map(Number.call,Number)};var i={1:{data:[],rowLabel:"Mario"},2:{data:[],rowLabel:"Luigi"},3:{data:[],rowLabel:"Peach"},4:{data:[],rowLabel:"Toad)"},5:{data:[],rowLabel:"Yoshi"},6:{data:[],rowLabel:"Bowser"},7:{data:[],rowLabel:"Boo"}};for(var j in i)i[j].data=Array.apply(null,new Array(30)).map(function(a,b){return{hour:b,value:Math.floor(1e3*Math.random()),xLabel:h.crazyAxis.xAxis[b]}});h.crazyData=i,h.crazyOptions={thresh:920,increments:12,width:1028,handleColor:"#F57F17",trackColor:"#BCAAA4",sliderTitle:"Stuff"},a.crazyValue=0,f.$on("konami",function(){a.$apply(function(){h.konami=!0,g(function(){window.scrollTo(0,window.innerHeight)},300)})})}]),angular.module("heatMap").directive("canvasHeatmap",[function(){return{restrict:"AE",transclude:!0,scope:{hmData:"=",axisLabels:"=",options:"=",severity:"=severity",colorArr:"="},link:function(a,b,c){function d(b){var c;return c=b>=a.options.thresh?9:parseInt(b/o)}function e(b){a.hmDataSource&&(l.clearRect(110,60,30*a.axisLabels.xAxis.length,30*a.axisLabels.yAxis),a.axisLabels.yAxis.forEach(function(c,d){j=30*(d+1)+30,b||(l.fillStyle="#333",l.font="bold 16px Arial",l.fillText(c,10,j,100));var e=110;a.hmDataSource[d+1]&&a.hmDataSource[d+1].data.forEach(function(b,c){var d=b.colorIndex>=a.severity?b.color:"#333";l.beginPath(),l.rect(e,j-25,30,30),l.fillStyle=d,l.fill(),n.push({x:e,y:j-10,w:30,h:30,tip:"Value: "+b.value}),e+=30,l.closePath()})}))}function f(){e(),l.strokeRect(10,j+5,100,33),m.x=10,m.y=j+5,m.width=100,m.height=33}function g(){var b=115;a.axisLabels.xAxis.forEach(function(a,c){l.fillStyle="#333",l.font="16px Arial",l.fillText(a,b,j+30,30),b+=30})}function h(){f(),g()}function i(b){for(var c in b)b[c].data.forEach(function(b,c){var e=d(b.value);b.colorIndex=e,b.color=a.colorArr[e]});a.hmDataSource=b,h()}a.severity=0,a.hmDataSource={},a.colorArr||(a.colorArr=["#01579B","#006064","#004D40","#1B5E20","#33691E","#827717","#F57F17","#FF6F00","#E65100","#B71C1C"]);var j,k=(a.axisLabels.xAxis.length,b[0]),l=k.getContext("2d"),m={},n=[],o=a.options.thresh/a.options.increments;window.innerWidth<=884?(a.skip=!0,a.xLabelWidth="82px"):(a.skip=!1,a.xLabelWidth="88px"),k.onmousemove=function(b){var c=this.getBoundingClientRect(),d=b.clientX-c.left,e=b.clientY-c.top;if(d>=110&&d<=30*a.axisLabels.xAxis.length+110&&e>=5&&e<=30*a.axisLabels.yAxis.length+60)for(var f=0;f<n.length;f++)d>=n[f].x&&d<=n[f].x+30&&e>=n[f].y&&e<=n[f].y+30&&(a.hoverValue=n[f].tip,l.clearRect(m.x,m.y,m.width,m.height),l.fillStyle="#333",l.font="bold 16px Arial",l.fillText(n[f].tip,m.x+10,m.y+22,100));else l.clearRect(m.x,m.y,m.width,m.height)},a.$watch("hmData",function(){i(a.hmData)}),a.$watch("severity",function(){e(!0)})}}}]),angular.module("heatMap").directive("rawHeatmap",[function(){return{restrict:"AE",transclude:!0,scope:{hmData:"=",axisLabels:"=",colorArr:"=",options:"="},templateUrl:"app/directives/rawHeatmapTemplate.html",link:function(a,b,c){function d(b){var c;return c=b>=a.options.thresh?9:parseInt(b/f)}function e(b){for(var c in b)b[c].data.forEach(function(b,c){var e=d(b.value);b.colorIndex=e,b.color=a.colorArr[e]});a.hmDataSource=b}a.severity=0,a.hmDataSource={},a.colorArr||(a.colorArr=["#01579B","#006064","#004D40","#1B5E20","#33691E","#827717","#F57F17","#FF6F00","#E65100","#B71C1C"]);var f=a.options.thresh/a.options.increments;window.innerWidth<=884?(a.skip=!0,a.xLabelWidth="82px"):(a.skip=!1,a.xLabelWidth="88px"),a.showPopover=function(b,c){a.style={left:b.pageX-40+"px",top:b.pageY-40+"px"},a.showWhich=c.id},a.hidePopover=function(b){a.showWhich=null},a.$watch("hmData",function(){e(a.hmData)})}}}]),angular.module("heatMap").directive("rangeSlider",[function(){return{restrict:"AE",transclude:!0,scope:{severity:"=",options:"="},controller:["$scope","$element","$attrs",function(a,b,c){function d(){i.beginPath(),i.rect(110,8,a.options.width-130,4),i.fillStyle=a.options.trackColor,i.fill(),i.closePath()}function e(){for(var b=l/(a.options.increments-1),c=0;c<a.options.increments;c++)i.beginPath(),i.rect(c*b+110,2.5,2,15),i.fillStyle=a.options.trackColor,i.fill(),i.closePath(),k.push(c*b+110)}function f(){i.beginPath(),i.rect(j.x,j.y,j.w,j.h),i.fillStyle=a.options.handleColor,i.fill(),i.closePath()}function g(b){var c={distance:a.options.width-130,tick:null},d=0;k.forEach(function(a,e){var f=Math.abs(b-a);f<c.distance&&(c.distance=f,c.tick=a,d=e)}),j.x=c.tick-3,a.$apply(function(){a.severity=d}),f()}var h=b[0],i=h.getContext("2d"),j={x:110,y:0,w:8,h:20},k=[],l=a.options.width-130,m=!1;i.fillStyle="#333",i.font="16px Arial",i.fillText(a.options.sliderTitle,10,16,100),h.onmousedown=function(a){var b=this.getBoundingClientRect(),c=a.clientX-b.left-4;a.clientY-b.top;c>=j.x&&c<=j.x+j.w?m=!0:(i.clearRect(j.x-20,j.y,j.w+50,j.h),j.x=c,d(),e(),f())},h.onmouseup=function(a){var b=this.getBoundingClientRect(),c=a.clientX-b.left;i.clearRect(j.x-20,j.y,j.w+100,j.h),m=!1,d(),e(),g(c)},h.onmousemove=function(a){if(m){i.clearRect(j.x-20,j.y,j.w+100,j.h);var b=this.getBoundingClientRect(),c=a.clientX-b.left;j.x=c,d(),e(),f()}},d(),e(),f()}]}}]),angular.module("heatMap").config(["$stateProvider",function(a){a.state("main",{url:"/",templateUrl:"app/views/mainView.html",controller:"MainCtrl",controllerAs:"vm"})}]),angular.module("heatMap").factory("WebService",["$http","$q",function(a,b){function c(a,c,d){var f=b.defer();if(a&&a.length){var g={},h=c.xAxis.length,i=0;a.forEach(function(a,b){var f=a.data[e][0][d];g.hasOwnProperty(a.index.dowId)||(g[a.index.dowId]={rowLabel:c.yAxis[a.index.dowId-1],data:[]}),g[a.index.dowId].data.push({hour:a.index.hourId,value:f,xLabel:c.xAxis[a.index.hourId]})});for(var j in g){var k=[],l=g[j].data.length,m=0;g[j].data=g[j].data.sort(function(a,b){return a.hour-b.hour});for(var n=0;n<h;n++)m<l&&n===g[j].data[m].hour?(g[j].data[m].id=i,k.push(g[j].data[m]),i++,m++):(k.push({hour:n,value:0,xLabel:c.xAxis[n],colorIndex:0,id:i}),i++);g[j].data=k}f.resolve(g)}else f.reject(!1);return f.promise}function d(d,e,f){var g=b.defer();return a.get("http://localhost:3000/api/getheatmapdata/"+d).success(function(a,b,d,h){!a.error&&a.data&&a.data.result?g.resolve(c(a.data.result,e,f)):g.resolve(a)}).error(function(a,b,c,d){console.log("error",a),g.resolve(a)}),g.promise}var e="Site Incident Heat Severity Map (lv12)";return{getHeatmapData:d}}]);